<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MedAssist â€” Medical Chatbot</title>
  <style>
    :root{
      --bg:#0f1724; /* dark navy */
      --panel:#0b1220;
      --accent:#06b6d4; /* cyan */
      --muted:#94a3b8;
      --glass: rgba(255,255,255,0.04);
      --radius:12px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071023 0%, #061425 100%);color:#e6eef6}

    .app{
      display:grid;
      grid-template-columns:320px 1fr;
      gap:20px;
      height:100vh;
      padding:20px;
      align-items:stretch;
    }

    /* Sidebar */
    .sidebar{
      background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius:var(--radius);
      padding:16px;display:flex;flex-direction:column;gap:12px;min-height:0; 
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700}
    .brand h1{font-size:15px;margin:0}
    .brand p{margin:0;font-size:12px;color:var(--muted)}

    .history{flex:1;overflow:auto;padding-right:4px}
    .conv-item{padding:10px;border-radius:8px;margin-bottom:8px;background:var(--glass);cursor:pointer}
    .conv-item small{color:var(--muted);display:block}

    .controls{display:flex;gap:8px}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#7c3aed);color:#041024;border:none}

    /* Main panel */
    .panel{display:flex;flex-direction:column;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--radius);padding:14px;min-height:0;}
    .header{display:flex;align-items:center;justify-content:space-between;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .title{display:flex;gap:12px;align-items:center}
    .title h2{margin:0;font-size:16px}
    .subtitle{font-size:12px;color:var(--muted)}

    .settings{display:flex;gap:8px;align-items:center}
    .chip{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:999px;font-size:13px;border:1px solid rgba(255,255,255,0.02)}

    /* chat area */
    .chat-wrap{display:flex;flex-direction:column;gap:12px;padding:12px;overflow:auto;flex:1}
    .msg{max-width:78%;padding:12px;border-radius:12px;line-height:1.35}
    .msg.assistant{background:linear-gradient(180deg, rgba(6,182,212,0.08), rgba(124,58,237,0.04));align-self:flex-start;border-top-left-radius:6px}
    .msg.user{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));align-self:flex-end;border-top-right-radius:6px}
    .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .typing{height:18px;display:inline-block}
    .dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:5px;opacity:0.2;animation:blink 1s infinite}
    .dot:nth-child(1){animation-delay:0s}.dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
    @keyframes blink{0%{opacity:.12}50%{opacity:1}100%{opacity:.12}}

    .composer{display:flex;gap:8px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.02);align-items:center}
    textarea{flex:1;min-height:44px;max-height:140px;padding:10px;border-radius:10px;background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.04);resize:none}
    .send{display:flex;gap:8px}

    .system-note{font-size:12px;color:var(--muted);padding:8px;background:rgba(255,255,255,0.01);border-radius:8px}

    /* small screens */
    @media (max-width:880px){
      .app{grid-template-columns:1fr;grid-auto-rows:1fr}
      .sidebar{order:2}
    }

    /* accessibility focus */
    .btn:focus, textarea:focus, .conv-item:focus{outline:3px solid rgba(6,182,212,0.14)}

  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Medical chat assistant">
    <aside class="sidebar" aria-label="Conversation list">
      <div class="brand">
        <div class="logo">MA</div>
        <div>
          <h1>MedAssist</h1>
          <p>Clinical Q&A Â· Evidence-aware</p>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="newConv">+ New</button>
        <button class="btn" id="saveConv">Save</button>
        <button class="btn" id="loadConv">Load</button>
      </div>

      <div class="history" id="history" tabindex="0" aria-live="polite">
        <!-- conversation items injected here -->
      </div>

      <div style="font-size:12px;color:var(--muted);padding-top:8px">
        <strong>Disclaimer:</strong> This chatbot provides general medical information and is not a substitute for professional medical advice.
      </div>
    </aside>

    <main class="panel" aria-live="polite">
      <div class="header">
        <div class="title">
          <h2 id="convTitle">New conversation</h2>
          <div class="subtitle">Ask about symptoms, medications, or guidelines.</div>
        </div>
        <div class="settings">
          <div class="chip" title="Model">gpt-med-1</div>
          <div class="chip" title="Temperature">Temp: <span id="tempVal">0.2</span></div>
        </div>
      </div>

      <div class="system-note" id="systemNote">
        System prompt: <em>Be a concise, evidence-aware medical assistant. If unsure, say "I don't know" and recommend seeing a clinician.</em>
      </div>

      <div class="chat-wrap" id="chat" role="log" aria-live="polite">
        <!-- messages go here -->
      </div>

      <form class="composer" id="composer" onsubmit="return false;" aria-label="Message composer">
        <textarea id="input" placeholder="Describe symptoms, ask about a condition, or paste clinical text..." aria-label="Message input"></textarea>
        <div class="send">
          <label for="fileUpload" class="btn" title="Attach file">ðŸ“Ž</label>
          <input type="file" id="fileUpload" style="display:none" />
          <button class="btn primary" id="sendBtn">Send</button>
        </div>
      </form>
    </main>
  </div>

  <script>
    // Simple client-side chat UI with hooks to integrate a backend API.
    const historyEl = document.getElementById('history');
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const convTitle = document.getElementById('convTitle');

    let conversations = []; // list of {id,title,messages}
    let activeConv = createConversation();

    function createConversation(title='New conversation'){
      const conv = {id:Date.now().toString(), title, messages:[]};
      conversations.unshift(conv);
      renderHistory();
      setActive(conv.id);
      return conv;
    }

    function renderHistory(){
      historyEl.innerHTML = '';
      conversations.forEach(c=>{
        const el = document.createElement('div');
        el.className = 'conv-item';
        el.tabIndex = 0;
        el.innerHTML = `<strong>${escapeHtml(c.title)}</strong><small>${c.messages.length} messages</small>`;
        el.onclick = ()=>setActive(c.id);
        historyEl.appendChild(el);
      });
    }

    function setActive(id){
      activeConv = conversations.find(c=>c.id===id);
      convTitle.textContent = activeConv.title||'Conversation';
      renderChat();
    }

    function renderChat(){
      chatEl.innerHTML='';
      activeConv.messages.forEach(m=>{
        const node = formatMessageNode(m);
        chatEl.appendChild(node);
      });
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function formatMessageNode(m){
      const div = document.createElement('div');
      div.className = 'msg ' + (m.role==='user'?'user':'assistant');
      const meta = document.createElement('div');meta.className='meta';
      meta.textContent = (m.role==='user'?'You':'MedAssist') + (m.time? ' Â· ' + new Date(m.time).toLocaleTimeString(): '');
      const content = document.createElement('div');
      content.innerHTML = sanitizeMessage(m.content);
      div.appendChild(meta);div.appendChild(content);
      return div;
    }

    function sanitizeMessage(s){
      // very simple sanitizer for demo. Replace with a proper library in production.
      return escapeHtml(s).replace(/\n/g,'<br>');
    }

    function escapeHtml(unsafe){
      return unsafe
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // Simulate assistant streaming response by gradually revealing text.
    async function streamAssistantReply(content){
      const msg = {role:'assistant', content:'', time:Date.now()};
      activeConv.messages.push(msg);
      renderChat();
      const node = chatEl.lastElementChild.querySelector('div:last-child');

      let i=0;
      const chunkSize = 40; // characters per chunk
      while(i < content.length){
        const next = content.slice(i, i+chunkSize);
        msg.content += next;
        node.innerHTML = sanitizeMessage(msg.content);
        chatEl.scrollTop = chatEl.scrollHeight;
        i += chunkSize;
        await new Promise(r=>setTimeout(r, 60)); // simulate network/typing
      }
      // finished
      renderChat();
    }

    // Hook send button
    sendBtn.addEventListener('click', async ()=>{
      const text = inputEl.value.trim();
      if(!text) return;
      const userMsg = {role:'user', content:text, time:Date.now()};
      activeConv.messages.push(userMsg);
      inputEl.value = '';
      renderChat();

      // show typing indicator
      const typingNode = document.createElement('div');
      typingNode.className = 'msg assistant';
      const meta = document.createElement('div');meta.className='meta';meta.textContent='MedAssist Â· typing';
      const dots = document.createElement('div');dots.className='typing';dots.innerHTML='<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      typingNode.appendChild(meta);typingNode.appendChild(dots);
      chatEl.appendChild(typingNode);chatEl.scrollTop = chatEl.scrollHeight;

      try{
        // Call backend API â€” replace URL with your server endpoint.
        // Expected request shape: { message: text, history: activeConv.messages }
        // Expected response: { reply: 'assistant text here' }

			const res = await fetch("/api/chat", {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify(payload),
			});
			const data = await res.json();
			chatEl.removeChild(typingNode);
			await streamAssistantReply(data.reply);


      }catch(err){
        chatEl.removeChild(typingNode);
        const errMsg = {role:'assistant', content:'Sorry â€” an error occurred. Please try again.', time:Date.now()};
        activeConv.messages.push(errMsg);
        renderChat();
      }
    });

    // Simple fake API for demo. Replace this with real fetch to your model/backend.
    async function fakeApiReply(payload){
      await new Promise(r=>setTimeout(r,700));
      // basic echo + suggestion
      const lastUser = payload.message;
      const reply = `Thanks â€” I heard: "${lastUser}"\n\nBased on that, here are next steps you can consider:\n1) If symptoms are severe (chest pain, breathlessness, fainting), seek emergency care.\n2) Monitor red flags and consult a clinician for an in-person assessment.\n3) If you'd like, paste vitals or medication list for more tailored advice.`;
      return {reply};
    }

    // Small utilities: save/load conversations to localStorage
    document.getElementById('saveConv').addEventListener('click',()=>{
      localStorage.setItem('medassist_convos', JSON.stringify(conversations));
      alert('Saved locally.');
    });
    document.getElementById('loadConv').addEventListener('click',()=>{
      const raw = localStorage.getItem('medassist_convos');
      if(!raw) return alert('No saved conversations found.');
      try{ conversations = JSON.parse(raw); setActive(conversations[0].id); renderHistory(); }catch(e){alert('Failed to load saved conversations.');}
    });
    document.getElementById('newConv').addEventListener('click',()=>createConversation());

    // initialize UI with a starter assistant message
    (async function init(){
      activeConv.messages.push({role:'assistant',content:'Hello â€” I am MedAssist. Tell me your symptoms or paste a clinical note. If this is an emergency, call your local emergency number.',time:Date.now()});
      renderChat();
      renderHistory();
    })();

    // Accessibility: send on Ctrl+Enter
    inputEl.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key === 'Enter') sendBtn.click();
    });

  </script>
</body>
</html>
